name: Daily Investment Briefing to Blog

on:
  schedule:
    - cron: '30 23 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Blog Repo
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Locate Automation Folder
      id: locate
      run: |
        # run_daily_briefing.py íŒŒì¼ì´ ì–´ë”” ìˆëŠ”ì§€ ì°¾ìŠµë‹ˆë‹¤.
        SCRIPT_PATH=$(find . -name "run_daily_briefing.py" | head -n 1)
        
        if [ -z "$SCRIPT_PATH" ]; then
          echo "âŒ Critical Error: run_daily_briefing.py not found!"
          exit 1
        fi
        
        # íŒŒì¼ì´ ìˆëŠ” ë””ë ‰í† ë¦¬ ê²½ë¡œ ì¶”ì¶œ
        WORK_DIR=$(dirname "$SCRIPT_PATH")
        echo "âœ… Found automation script at: $WORK_DIR"
        echo "work_dir=$WORK_DIR" >> $GITHUB_OUTPUT

    - name: Install Dependencies
      run: |
        WORK_DIR="${{ steps.locate.outputs.work_dir }}"
        cd "$WORK_DIR"
        if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
        else
            echo "âš ï¸ No requirements.txt found in $WORK_DIR"
        fi

    - name: Run Daily Analysis
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        WORK_DIR="${{ steps.locate.outputs.work_dir }}"
        cd "$WORK_DIR"
        python run_daily_briefing.py

    - name: Format for Blog
      run: |
        WORK_DIR="${{ steps.locate.outputs.work_dir }}"
        
        # ë¶„ì„ ê²°ê³¼ì™€ ìœ í‹¸ë¦¬í‹°ë¥¼ ë£¨íŠ¸ë¡œ ê°€ì ¸ì™€ì„œ ì²˜ë¦¬ (ê²½ë¡œ ë¬¸ì œ ë‹¨ìˆœí™”)
        echo "Moving artifacts from $WORK_DIR to root..."
        cp -r "$WORK_DIR/analysis_result" . 2>/dev/null || true
        
        # utils í´ë” ì°¾ê¸° (automation ì•ˆì— ìˆê±°ë‚˜ ë£¨íŠ¸ì— ìˆê±°ë‚˜)
        UTILS_PATH=$(find . -type d -name "utils" | grep -v "site-packages" | head -n 1)
        if [ -n "$UTILS_PATH" ]; then
             python "$UTILS_PATH/format_for_blog.py"
        else
             echo "âŒ Error: utils folder not found"
             exit 1
        fi

    - name: Commit and Push Blog Post
      run: |
        git config --global user.name 'NewsBot'
        git config --global user.email 'bot@noreply.github.com'
        
        # _posts í´ë” ìƒì„± ë° í™•ì¸
        mkdir -p _posts
        
        git add _posts/
        if git diff --staged --quiet; then
          echo "No changes to commit."
          exit 0
        fi
        git commit -m "ğŸ¤– Add Daily Investment Briefing $(date +'%Y-%m-%d')"
        git push
