name: Daily Investment Briefing to Blog

on:
  schedule:
    - cron: '30 23 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Blog Repo
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Locate Automation Script
      id: locate
      run: |
        SCRIPT_PATH=$(find . -name "run_daily_briefing.py" | head -n 1)
        if [ -z "$SCRIPT_PATH" ]; then
          echo "âŒ setup failed: script not found"
          exit 1
        fi
        WORK_DIR=$(dirname "$SCRIPT_PATH")
        echo "work_dir=$WORK_DIR" >> $GITHUB_OUTPUT
        echo "âœ… Working Directory: $WORK_DIR"

    - name: Install Dependencies
      run: |
        WORK_DIR="${{ steps.locate.outputs.work_dir }}"
        cd "$WORK_DIR"
        pip install -r requirements.txt || pip install -r ../requirements.txt || echo "âš ï¸ No requirements found"

    - name: Run Analysis
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        WORK_DIR="${{ steps.locate.outputs.work_dir }}"
        cd "$WORK_DIR"
        
        # ê°•ì œë¡œ ì‹¤í–‰ë˜ë„ë¡ ê¸°ì¡´ ê²°ê³¼ ë¬´ì‹œ ì˜µì…˜ ê°™ì€ê²Œ ì—†ìœ¼ë‹ˆ, ê·¸ëƒ¥ ì‹¤í–‰
        echo "ğŸš€ Running analysis script..."
        python run_daily_briefing.py
        
        # ê²°ê³¼ íŒŒì¼ì´ ìƒê²¼ëŠ”ì§€ ë¦¬ìŠ¤íŒ…
        echo "ğŸ“‚ Checking for generated files..."
        find . -name "*.md"
        
        # ìƒìœ„ í´ë”ë¡œ ê²°ê³¼ë¬¼ ë³µì‚¬ (ì¤‘ìš”!)
        # analysis_result í´ë”ê°€ ì–´ë””ì— ìƒê²¼ë“  ë‹¤ ëŒê³  ì˜¨ë‹¤
        mkdir -p ../../analysis_temp
        cp -r analysis_result/* ../../analysis_temp/ 2>/dev/null || true
        # í˜¹ì€ í˜„ì¬ í´ë”(root)ë¡œ ë³µì‚¬
        # cd ..
        # cp -r "$WORK_DIR/analysis_result" .

    - name: Format and Move to Posts
      run: |
        # WORK_DIR="${{ steps.locate.outputs.work_dir }}"
        
        # 1. ì•„ê¹Œ ë³µì‚¬í•´ë‘” temp í´ë”ì—ì„œ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
        if [ -d "analysis_temp" ]; then
            echo "âœ… Found analysis files in temp, moving to expected path..."
            mkdir -p automation/analysis_result
            cp -r analysis_temp/* automation/analysis_result/ 2>/dev/null || true
            cp -r analysis_temp/* analysis_result/ 2>/dev/null || true
        fi

        # 2. utils ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ê²½ë¡œ ìœ ì—°í•˜ê²Œ)
        UTILS_SCRIPT=$(find . -name "format_for_blog.py" | head -n 1)
        if [ -n "$UTILS_SCRIPT" ]; then
            echo "ğŸš€ Running formatter: $UTILS_SCRIPT"
            
            # format_for_blog.pyëŠ” í˜„ì¬ ë‚ ì§œì˜ í´ë”ë¥¼ ì°¾ìŒ.
            # ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•´ì„œ _postsë¡œ ì˜®ê¹€
            python "$UTILS_SCRIPT"
        else
            echo "âŒ formater script not found!"
            exit 1
        fi

    - name: Check and Push
      run: |
        ls -R _posts/
        
        git config --global user.name 'NewsBot'
        git config --global user.email 'bot@noreply.github.com'
        
        git add _posts/
        
        if git diff --staged --quiet; then
          echo "âš ï¸ No new posts created. Nothing to commit."
        else
          git commit -m "ğŸ¤– Add Daily Investment Briefing $(date +'%Y-%m-%d')"
          git push
        fi
