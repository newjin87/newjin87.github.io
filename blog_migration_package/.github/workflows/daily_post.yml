name: Daily Investment Briefing to Blog

# ë§¤ì¼ í•œêµ­ ì‹œê°„ ì˜¤ì „ 8ì‹œ 30ë¶„ (UTC 23:30) ì‹¤í–‰
on:
  schedule:
    - cron: '30 23 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Blog Repo
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        # automation í´ë”ê°€ ìˆë‹¤ë©´ ê±°ê¸°ë¡œ ë“¤ì–´ê°€ì„œ ì‹¤í–‰ (êµ¬ì¡°ì— ë”°ë¼ ìˆ˜ì • í•„ìš”)
        # í˜„ì¬ ì œì•ˆ êµ¬ì¡°: rootì— ì½”ë“œê°€ ìˆëŠ” ê²½ìš°
        if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
        elif [ -f "automation/requirements.txt" ]; then
            pip install -r automation/requirements.txt
        fi

    - name: Run Daily Analysis
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        # ì‹¤í–‰ ìœ„ì¹˜ ì¡°ì •
        if [ -d "automation" ]; then
            cd automation
            python run_daily_briefing.py
            cd ..
        else
            python run_daily_briefing.py
        fi

    - name: Format for Blog
      run: |
        # ë¶„ì„ ê²°ê³¼(analysis_result)ëŠ” ì‹¤í–‰ ìœ„ì¹˜ì— ìƒê¹€
        # format_for_blog.pyëŠ” _postsë¡œ íŒŒì¼ì„ ì˜®ê²¨ì¤Œ
        
        if [ -d "automation" ]; then
            # automation í´ë” ì•ˆì—ì„œ ë¶„ì„í–ˆìœ¼ë¯€ë¡œ ê²°ê³¼ë„ ê·¸ ì•ˆì— ìˆìŒ
            # ìŠ¤í¬ë¦½íŠ¸ëŠ” ë£¨íŠ¸ ê¸°ì¤€ì˜ _postsë¡œ íŒŒì¼ì„ êº¼ë‚´ì™€ì•¼ í•¨.
            # í•˜ì§€ë§Œ format_for_blog.pyëŠ” ìƒëŒ€ ê²½ë¡œë¥¼ ì”€.
            # ê°€ì¥ ì‰¬ìš´ ë°©ë²•: automation í´ë”ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰í•˜ë˜, íƒ€ê²Ÿì„ ìƒìœ„(../_posts)ë¡œ ì§€ì •í•˜ë„ë¡ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì§œê±°ë‚˜
            # ì—¬ê¸°ì„œ íŒŒì¼ì„ ì´ë™í•´ì£¼ê¸°.
            
            # format_for_blog.pyê°€ 'analysis_result'ë¥¼ ì°¾ëŠ”ë°, ì´ê²Œ automation ì•ˆì— ìˆìŒ.
            # ê°„ë‹¨íˆ automation í´ë”ë¡œ ë“¤ì–´ê°€ì„œ ì‹¤í–‰í•˜ê³ , _posts ê²½ë¡œë§Œ ìˆ˜ì •í•´ì£¼ë©´ ë¨.
            # í•˜ì§€ë§Œ ì´ë¯¸ ì‘ì„±ëœ íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ëŠ” "_posts"ë¥¼ ì°¾ìŒ.
            
            # ì—¬ê¸°ì„œ ì„ì‹œë¡œ automation/analysis_resultë¥¼ . ë¡œ ê°€ì ¸ì˜¤ì.
            cp -r automation/analysis_result .
            python automation/utils/format_for_blog.py
        else
            python utils/format_for_blog.py
        fi

    - name: Commit and Push Blog Post
      run: |
        git config --global user.name 'NewsBot'
        git config --global user.email 'bot@noreply.github.com'
        
        # _posts í´ë”ì— ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
        git add _posts/
        
        # ë³€ê²½ì‚¬í•­ì´ ì—†ìœ¼ë©´ ì»¤ë°‹í•˜ì§€ ì•Šê³  ì¢…ë£Œ
        if git diff --staged --quiet; then
          echo "No changes to commit."
          exit 0
        fi
        
        git commit -m "ğŸ¤– Add Daily Investment Briefing $(date +'%Y-%m-%d')"
        git push
